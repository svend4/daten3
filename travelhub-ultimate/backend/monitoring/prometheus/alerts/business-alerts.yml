# Business Metrics Alerting Rules for TravelHub

groups:
  - name: business_alerts
    interval: 60s
    rules:
      # Low Booking Rate
      - alert: LowBookingRate
        expr: rate(bookings_total{status="completed"}[1h]) < 0.1
        for: 30m
        labels:
          severity: warning
          category: business
        annotations:
          summary: "Low booking rate detected"
          description: "Booking rate is {{ $value }} bookings/s (threshold: 0.1 bookings/s)"

      # High Booking Cancellation Rate
      - alert: HighCancellationRate
        expr: |
          (
            rate(bookings_total{status="cancelled"}[1h])
            /
            rate(bookings_total[1h])
          ) > 0.2
        for: 1h
        labels:
          severity: warning
          category: business
        annotations:
          summary: "High booking cancellation rate"
          description: "Cancellation rate is {{ $value | humanizePercentage }} (threshold: 20%)"

      # Authentication Failures
      - alert: HighAuthFailureRate
        expr: |
          (
            rate(auth_attempts_total{status="failure"}[5m])
            /
            rate(auth_attempts_total[5m])
          ) > 0.3
        for: 10m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "High authentication failure rate"
          description: "Auth failure rate is {{ $value | humanizePercentage }} (threshold: 30%)"

      # Low Search Activity
      - alert: LowSearchActivity
        expr: sum(rate(searches_total[1h])) < 1
        for: 2h
        labels:
          severity: info
          category: business
        annotations:
          summary: "Low search activity"
          description: "Search rate is {{ $value }} searches/s (threshold: 1 search/s)"

      # Revenue Drop
      - alert: RevenueDropDetected
        expr: |
          (
            rate(booking_revenue_total[1h])
            -
            rate(booking_revenue_total[1h] offset 24h)
          ) < -0.5
        for: 2h
        labels:
          severity: warning
          category: business
        annotations:
          summary: "Revenue drop detected"
          description: "Revenue has dropped significantly compared to 24h ago"

      # Active Users Drop
      - alert: ActiveUsersDropped
        expr: |
          (
            active_users
            -
            (active_users offset 1h)
          ) < -100
        for: 30m
        labels:
          severity: info
          category: engagement
        annotations:
          summary: "Active users dropped significantly"
          description: "Active users dropped by {{ $value }} in the last hour"

      # No New User Registrations
      - alert: NoNewRegistrations
        expr: increase(users_total[4h]) == 0
        for: 4h
        labels:
          severity: info
          category: growth
        annotations:
          summary: "No new user registrations"
          description: "No new users registered in the last 4 hours"

      # Excessive Rate Limiting
      - alert: ExcessiveRateLimiting
        expr: rate(rate_limit_exceeded_total[5m]) > 10
        for: 15m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Excessive rate limiting triggered"
          description: "Rate limit exceeded {{ $value }} times/s (may indicate attack or misconfiguration)"
