<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ CORS</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .test-btn:hover {
            background: #45a049;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ CORS</h1>

        <div class="info" style="margin-bottom: 20px;">
            <strong>‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç!</strong><br>
            –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Frontend ‚Üí Backend
        </div>

        <button class="test-btn" onclick="testCORS()">
            üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É CORS
        </button>

        <div id="result"></div>

        <div style="margin-top: 30px;">
            <h3>üìù –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:</h3>
            <div class="step">
                <strong>1. Health Check</strong><br>
                Backend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
            </div>
            <div class="step">
                <strong>2. CORS Headers</strong><br>
                Access-Control-Allow-Origin —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            </div>
            <div class="step">
                <strong>3. Credentials</strong><br>
                Cookies –º–æ–≥—É—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è
            </div>
            <div class="step">
                <strong>4. CSRF Token</strong><br>
                –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://daten3-1.onrender.com';
        const FRONTEND_URL = 'https://daten3.onrender.com';

        async function testCORS() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="info">‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...</div>';

            const results = [];

            // Test 1: Health Check
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    results.push('‚úÖ Test 1: Health Check - PASSED');
                    results.push(`   Response: ${JSON.stringify(data)}`);
                } else {
                    results.push(`‚ùå Test 1: Health Check - FAILED (${response.status})`);
                }
            } catch (error) {
                results.push(`‚ùå Test 1: Health Check - ERROR: ${error.message}`);
            }

            // Test 2: CORS Headers
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const corsOrigin = response.headers.get('access-control-allow-origin');
                const corsCredentials = response.headers.get('access-control-allow-credentials');

                if (corsOrigin === FRONTEND_URL || corsOrigin === window.location.origin) {
                    results.push('‚úÖ Test 2: CORS Headers - PASSED');
                    results.push(`   Origin: ${corsOrigin}`);
                    results.push(`   Credentials: ${corsCredentials}`);
                } else if (corsOrigin) {
                    results.push('‚ö†Ô∏è Test 2: CORS Headers - WARNING');
                    results.push(`   Expected: ${FRONTEND_URL}`);
                    results.push(`   Got: ${corsOrigin}`);
                } else {
                    results.push('‚ùå Test 2: CORS Headers - FAILED');
                    results.push('   No Access-Control-Allow-Origin header found');
                }
            } catch (error) {
                results.push(`‚ùå Test 2: CORS Headers - ERROR: ${error.message}`);
            }

            // Test 3: CSRF Token
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/csrf-token`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.data && data.data.csrfToken) {
                        results.push('‚úÖ Test 3: CSRF Token - PASSED');
                        results.push(`   Token: ${data.data.csrfToken.substring(0, 30)}...`);
                    } else {
                        results.push('‚ùå Test 3: CSRF Token - FAILED (no token)');
                    }
                } else {
                    results.push(`‚ùå Test 3: CSRF Token - FAILED (${response.status})`);
                }
            } catch (error) {
                results.push(`‚ùå Test 3: CSRF Token - ERROR: ${error.message}`);
            }

            // Summary
            const passed = results.filter(r => r.includes('‚úÖ')).length;
            const total = 3;

            results.push('');
            results.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            results.push(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ`);

            let finalClass = 'info';
            let finalMessage = '';

            if (passed === total) {
                finalClass = 'success';
                finalMessage = '\n\nüéâ –í–°–Å –†–ê–ë–û–¢–ê–ï–¢!\n\nFrontend —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Backend!\nCORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!';
            } else if (passed > 0) {
                finalClass = 'info';
                finalMessage = '\n\n‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç\n\n–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ FRONTEND_URL –≤ Render Dashboard.';
            } else {
                finalClass = 'error';
                finalMessage = '\n\n‚ùå CORS –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç\n\nFrontend –ù–ï –ú–û–ñ–ï–¢ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Backend!\n\n–î–µ–π—Å—Ç–≤–∏—è:\n1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ FRONTEND_URL –≤ Render\n2. –°–¥–µ–ª–∞–π—Ç–µ Manual Deploy\n3. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 5 –º–∏–Ω—É—Ç\n4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É';
            }

            results.push(finalMessage);

            resultDiv.innerHTML = `<div class="result ${finalClass}">${results.join('\n')}</div>`;
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            setTimeout(testCORS, 1000);
        });
    </script>
</body>
</html>
